FROM ghcr.io/linuxserver/baseimage-alpine:3.22

WORKDIR /app

ENV PUID=1000 \
    PGID=1000 \
    TZ=Asia/Shanghai \
    LANG=C.UTF-8 \
    PYTHONUNBUFFERED=1 

RUN apk add --no-cache \
      git \
      python3 \
      py3-pip \
      bash \
      coreutils \
      sed \
      tzdata \
    && git clone https://github.com/Toperlock/sing-box-subscribe /app \
    && mkdir -p /origin \
    && cp -r /app/* /origin/ \
    && python3 -m venv /venv \
    && . /venv/bin/activate \
    && pip install --upgrade pip setuptools wheel gunicorn \
    && pip install --no-cache-dir -r /app/requirements.txt \
    && rm -rf /var/cache/apk/* /tmp/* /root/.cache/pip

ENV PATH="/venv/bin:$PATH"
    
# 创建配置目录并设置权限模板
RUN \
    mkdir -p /config && \
    rm /app/vercel.json && \
    rm /app/providers.json && \
    rm -r /app/config_template && \
    ln -s /config/providers.json /app/providers.json && \
    ln -s /config/vercel.json /app/vercel.json && \
    ln -s /config/config_template /app/config_template && \
    # 设置目录权限模板
    chmod -R 755 /config /app && \
    chown -R abc:users /config /app

# 添加s6服务脚本
COPY root/ /

# 暴露配置目录（供挂载）
VOLUME /config

# 暴露端口
EXPOSE 5000