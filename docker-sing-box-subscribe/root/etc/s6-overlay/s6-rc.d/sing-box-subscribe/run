#!/usr/bin/with-contenv bash
# ==============================================================================
# FundMonitor 启动脚本
# 使用 with-contenv 加载环境变量，s6-overlay 管理进程
# ==============================================================================

cd /app || exit 1
# 1. 确保 /config/providers.json 存在
if [ ! -d /config/config_template ]; then
    echo "未检测到 /config/config_template，创建空配置文件..."
    cp -r /origin/config_template /config/config_template
fi

if [ ! -d /app/config_template ]; then
    echo "未检测到 /app/config_template，创建空配置文件..."
    ln -s /config/config_template /app/config_template
fi

if [ ! -f /config/providers.json ]; then
    echo "未检测到 /config/providers.json，创建空配置文件..."
    cp /origin/providers.json /config/providers.json
fi

# 2. 确保 /app/providers.json 存在并指向 /config/providers.json
if [ ! -f /app/providers.json ]; then
    echo "未检测到 /app/providers.json，创建软链接指向 /config/providers.json..."
    ln -s /config/providers.json /app/providers.json
fi

if [ ! -f /config/vercel.json ]; then
    echo "未检测到 /config/vercel.json，创建空配置文件..."
    cp /origin/vercel.json /config/vercel.json
fi

# 2. 确保 /app/vercel.json 存在并指向 /config/vercel.json
if [ ! -f /app/vercel.json ]; then
    echo "未检测到 /app/vercel.json，创建软链接指向 /config/vercel.json..."
    ln -s /config/vercel.json /app/vercel.json
fi
chown -R abc:users /app
chown -R abc:users /config
# 3. 切换到指定 PUID/PGID 用户运行程序
: "${PUID:=1000}"
: "${PGID:=1000}"
echo "以 UID:${PUID} GID:${PGID} 启动 sing-box-subscribe..."

# 使用 Gunicorn 启动 Flask 应用，仅监听内网
exec s6-setuidgid "${PUID}:${PGID}" \
    gunicorn -w 4 -b 0.0.0.0:5000 api.app:app
